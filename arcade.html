<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Space Defense</title>
    <script src="https://portals-labs.github.io/portals-sdk/portals-sdk.js?v=38472916"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #1A1510;
            color: #F0E6D8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
        }

        .arcade-cabinet {
            background: linear-gradient(145deg, #2D2520, #252019);
            border: 3px solid #4D4038;
            border-radius: 12px;
            box-shadow:
                0 0 20px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            padding: 20px;
        }

        .arcade-header {
            background: linear-gradient(90deg, #4D4038, #3D3028);
            margin: -20px -20px 15px -20px;
            padding: 10px 20px;
            border-radius: 9px 9px 0 0;
            border-bottom: 2px solid #5D5048;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .arcade-title {
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: #D4763A;
            text-shadow: 0 0 10px rgba(212, 118, 58, 0.3);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .score-display {
            font-size: 11px;
            font-weight: bold;
            color: #4CAF8C;
            text-shadow: 0 0 8px rgba(74, 175, 140, 0.5);
        }

        .close-btn {
            width: 24px;
            height: 24px;
            background: linear-gradient(180deg, #5D5048, #4D4038);
            border: 2px solid #6D6058;
            border-radius: 6px;
            color: #A09080;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .close-btn:hover {
            background: linear-gradient(180deg, #6D6058, #5D5048);
            color: #F0E6D8;
            border-color: #7D7068;
        }

        .close-btn:active {
            transform: scale(0.95);
        }

        .game-screen {
            background: #0A0806;
            border: 2px solid #3D3028;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            image-rendering: pixelated;
        }

        canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .game-controls {
            margin-top: 12px;
            text-align: center;
            font-size: 9px;
            color: #6D5D4D;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .game-controls span {
            color: #D4763A;
        }

        .game-over-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 8, 6, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .game-over-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .game-over-text {
            font-size: 18px;
            font-weight: bold;
            color: #D4763A;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 15px rgba(212, 118, 58, 0.8);
        }

        .final-score {
            font-size: 12px;
            color: #F0E6D8;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .restart-btn {
            background: linear-gradient(180deg, #D4763A, #B45A2A);
            border: 2px solid #E8864A;
            border-radius: 6px;
            color: #FFF;
            padding: 8px 16px;
            font-family: inherit;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 3px 0 #8A4A1A;
        }

        .restart-btn:hover {
            background: linear-gradient(180deg, #E8864A, #C46A3A);
            transform: translateY(-1px);
        }

        .restart-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #8A4A1A;
        }

        .start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 8, 6, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .start-overlay.hidden {
            display: none;
        }

        .start-title {
            font-size: 16px;
            font-weight: bold;
            color: #D4763A;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 15px rgba(212, 118, 58, 0.8);
        }

        .start-btn {
            background: linear-gradient(180deg, #D4763A, #B45A2A);
            border: 2px solid #E8864A;
            border-radius: 6px;
            color: #FFF;
            padding: 10px 24px;
            font-family: inherit;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 3px 0 #8A4A1A;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 3px 0 #8A4A1A, 0 0 10px rgba(212, 118, 58, 0.3); }
            50% { box-shadow: 0 3px 0 #8A4A1A, 0 0 20px rgba(212, 118, 58, 0.6); }
        }

        .start-btn:hover {
            background: linear-gradient(180deg, #E8864A, #C46A3A);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="arcade-cabinet">
        <div class="arcade-header">
            <div class="arcade-title">Space Defense</div>
            <div class="header-right">
                <div class="score-display">Score: <span id="score">0</span></div>
                <button class="close-btn" id="close-btn">&times;</button>
            </div>
        </div>
        <div class="game-screen">
            <canvas id="game" width="280" height="320"></canvas>
            <div class="start-overlay" id="start-overlay">
                <div class="start-title">Space Defense</div>
                <button class="start-btn" id="start-btn">Start Game</button>
            </div>
            <div class="game-over-overlay" id="game-over">
                <div class="game-over-text">Game Over</div>
                <div class="final-score">Score: <span id="final-score">0</span></div>
                <button class="restart-btn" id="restart-btn">Play Again</button>
            </div>
        </div>
        <div class="game-controls">
            <span>A/D</span> or <span>Arrows</span> to move &bull; <span>Space</span> to shoot
        </div>
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const finalScoreDisplay = document.getElementById('final-score');
        const gameOverOverlay = document.getElementById('game-over');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const closeBtn = document.getElementById('close-btn');

        // Portals integration
        const Portals = {
            completeTask(taskName) {
                const message = JSON.stringify({
                    TaskName: taskName,
                    TaskTargetState: 'SetActiveToCompleted'
                });

                console.log('Sending to Portals:', message);

                if (typeof PortalsSdk !== 'undefined') {
                    PortalsSdk.sendMessageToUnity(message);
                } else {
                    console.log('PortalsSdk not available - running in dev mode');
                }
            },

            closeIframe() {
                console.log('Closing iframe');
                if (typeof PortalsSdk !== 'undefined') {
                    PortalsSdk.closeIframe();
                } else {
                    console.log('PortalsSdk not available - running in dev mode');
                }
            }
        };

        let gameCompleted = false;

        // Colors matching the theme
        const COLORS = {
            ship: '#D4763A',
            shipAccent: '#E8864A',
            bullet: '#4CAF8C',
            alien1: '#8B5A3C',
            alien2: '#6D4D3A',
            alien3: '#4D3D2A',
            alienAccent: '#A07060',
            explosion: '#E8864A',
            star: '#3D3028'
        };

        // Game state
        let gameRunning = false;
        let score = 0;
        let player = { x: 140, y: 290, width: 20, height: 16, speed: 4 };
        let bullets = [];
        let aliens = [];
        let particles = [];
        let stars = [];
        let keys = {};
        let lastShot = 0;
        let shotCooldown = 250;
        let alienSpawnTimer = 0;
        let alienSpawnRate = 60;
        let difficulty = 1;

        // Initialize stars
        function initStars() {
            stars = [];
            for (let i = 0; i < 30; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 1,
                    speed: Math.random() * 0.5 + 0.2
                });
            }
        }

        // Draw pixel ship
        function drawShip(x, y) {
            ctx.fillStyle = COLORS.ship;
            // Body
            ctx.fillRect(x + 8, y, 4, 4);
            ctx.fillRect(x + 6, y + 4, 8, 4);
            ctx.fillRect(x + 4, y + 8, 12, 4);
            ctx.fillRect(x + 2, y + 12, 16, 4);
            // Cockpit
            ctx.fillStyle = COLORS.shipAccent;
            ctx.fillRect(x + 8, y + 4, 4, 4);
            // Wings accent
            ctx.fillRect(x + 2, y + 12, 2, 4);
            ctx.fillRect(x + 16, y + 12, 2, 4);
        }

        // Draw pixel alien
        function drawAlien(alien) {
            const x = alien.x;
            const y = alien.y;
            const type = alien.type;

            if (type === 0) {
                // Bug-like alien
                ctx.fillStyle = COLORS.alien1;
                ctx.fillRect(x + 4, y, 8, 4);
                ctx.fillRect(x + 2, y + 4, 12, 4);
                ctx.fillRect(x, y + 8, 4, 4);
                ctx.fillRect(x + 12, y + 8, 4, 4);
                ctx.fillStyle = COLORS.alienAccent;
                ctx.fillRect(x + 4, y + 4, 2, 2);
                ctx.fillRect(x + 10, y + 4, 2, 2);
            } else if (type === 1) {
                // Squid-like alien
                ctx.fillStyle = COLORS.alien2;
                ctx.fillRect(x + 6, y, 4, 4);
                ctx.fillRect(x + 2, y + 4, 12, 4);
                ctx.fillRect(x + 4, y + 8, 8, 4);
                ctx.fillRect(x + 2, y + 12, 4, 2);
                ctx.fillRect(x + 10, y + 12, 4, 2);
                ctx.fillStyle = COLORS.alienAccent;
                ctx.fillRect(x + 6, y + 6, 4, 2);
            } else {
                // Skull-like alien
                ctx.fillStyle = COLORS.alien3;
                ctx.fillRect(x + 4, y, 8, 4);
                ctx.fillRect(x + 2, y + 4, 12, 8);
                ctx.fillRect(x + 4, y + 12, 2, 2);
                ctx.fillRect(x + 10, y + 12, 2, 2);
                ctx.fillStyle = COLORS.alienAccent;
                ctx.fillRect(x + 4, y + 6, 2, 2);
                ctx.fillRect(x + 10, y + 6, 2, 2);
                ctx.fillRect(x + 6, y + 10, 4, 2);
            }
        }

        // Draw bullet
        function drawBullet(bullet) {
            ctx.fillStyle = COLORS.bullet;
            ctx.fillRect(bullet.x, bullet.y, 2, 6);
            ctx.fillStyle = 'rgba(74, 175, 140, 0.5)';
            ctx.fillRect(bullet.x - 1, bullet.y + 6, 4, 4);
        }

        // Draw particle
        function drawParticle(p) {
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life;
            ctx.fillRect(p.x, p.y, p.size, p.size);
            ctx.globalAlpha = 1;
        }

        // Draw stars
        function drawStars() {
            ctx.fillStyle = COLORS.star;
            stars.forEach(star => {
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });
        }

        // Update stars
        function updateStars() {
            stars.forEach(star => {
                star.y += star.speed;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });
        }

        // Create explosion particles
        function createExplosion(x, y) {
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: x + 8,
                    y: y + 8,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    size: Math.random() * 3 + 2,
                    life: 1,
                    color: Math.random() > 0.5 ? COLORS.explosion : COLORS.ship
                });
            }
        }

        // Spawn alien
        function spawnAlien() {
            const type = Math.floor(Math.random() * 3);
            aliens.push({
                x: Math.random() * (canvas.width - 16),
                y: -16,
                width: 16,
                height: 14,
                type: type,
                speed: 1 + Math.random() * difficulty * 0.5,
                wobble: Math.random() * Math.PI * 2,
                wobbleSpeed: 0.05 + Math.random() * 0.05
            });
        }

        // Update game
        function update() {
            if (!gameRunning) return;

            // Player movement
            if (keys['ArrowLeft'] || keys['KeyA']) {
                player.x = Math.max(0, player.x - player.speed);
            }
            if (keys['ArrowRight'] || keys['KeyD']) {
                player.x = Math.min(canvas.width - player.width, player.x + player.speed);
            }

            // Shooting
            if (keys['Space'] && Date.now() - lastShot > shotCooldown) {
                bullets.push({
                    x: player.x + player.width / 2 - 1,
                    y: player.y - 6
                });
                lastShot = Date.now();
            }

            // Update bullets
            bullets = bullets.filter(bullet => {
                bullet.y -= 6;
                return bullet.y > -10;
            });

            // Spawn aliens
            alienSpawnTimer++;
            if (alienSpawnTimer >= alienSpawnRate) {
                spawnAlien();
                alienSpawnTimer = 0;
                // Increase difficulty over time
                if (alienSpawnRate > 30) {
                    alienSpawnRate -= 0.5;
                }
                difficulty += 0.02;
            }

            // Update aliens
            aliens = aliens.filter(alien => {
                alien.y += alien.speed;
                alien.wobble += alien.wobbleSpeed;
                alien.x += Math.sin(alien.wobble) * 0.5;

                // Check collision with player
                if (alien.y + alien.height > player.y &&
                    alien.x < player.x + player.width &&
                    alien.x + alien.width > player.x) {
                    gameOver();
                    return false;
                }

                // Check if alien reached bottom
                if (alien.y > canvas.height) {
                    gameOver();
                    return false;
                }

                return true;
            });

            // Bullet-alien collisions
            bullets = bullets.filter(bullet => {
                let hit = false;
                aliens = aliens.filter(alien => {
                    if (bullet.x < alien.x + alien.width &&
                        bullet.x + 2 > alien.x &&
                        bullet.y < alien.y + alien.height &&
                        bullet.y + 6 > alien.y) {
                        hit = true;
                        createExplosion(alien.x, alien.y);
                        score += 10;
                        scoreDisplay.textContent = score;

                        // Complete task when score reaches 100
                        if (score >= 100 && !gameCompleted) {
                            gameCompleted = true;
                            Portals.completeTask('gamecomplete');
                        }
                        return false;
                    }
                    return true;
                });
                return !hit;
            });

            // Update particles
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.03;
                return p.life > 0;
            });

            updateStars();
        }

        // Draw game
        function draw() {
            // Clear
            ctx.fillStyle = '#0A0806';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawStars();

            // Draw bullets
            bullets.forEach(drawBullet);

            // Draw aliens
            aliens.forEach(drawAlien);

            // Draw particles
            particles.forEach(drawParticle);

            // Draw player
            if (gameRunning) {
                drawShip(player.x, player.y);
            }
        }

        // Game loop
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Game over
        function gameOver() {
            gameRunning = false;
            finalScoreDisplay.textContent = score;
            gameOverOverlay.classList.add('visible');
        }

        // Start/restart game
        function startGame() {
            gameRunning = true;
            score = 0;
            scoreDisplay.textContent = '0';
            player.x = 140;
            bullets = [];
            aliens = [];
            particles = [];
            alienSpawnTimer = 0;
            alienSpawnRate = 60;
            difficulty = 1;
            gameOverOverlay.classList.remove('visible');
            startOverlay.classList.add('hidden');
            initStars();
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (e.code === 'Space') e.preventDefault();
        });

        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);
        closeBtn.addEventListener('click', () => Portals.closeIframe());

        // Initialize
        initStars();
        gameLoop();
    </script>
</body>
</html>
