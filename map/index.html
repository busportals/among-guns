<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dead Signal Map</title>
    <script src="https://portals-labs.github.io/portals-sdk/portals-sdk.js?v=10005456"></script>
    <style>
      html, body, #root {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      /* High specificity for transparent backgrounds */
      html, html > body, html > body > #root {
        background-color: transparent;
        background: none;
      }

      /* Override any dark backgrounds from the React app */
      #root [class*="dark" i],
      #root [class*="bg-" i] {
        background-color: transparent !important;
      }
    </style>
    <script type="module" crossorigin src="/among-guns/map/assets/index-DnFOBFND.js"></script>
    <link rel="stylesheet" crossorigin href="/among-guns/map/assets/index-D2LpBZhN.css">
  </head>

  <body>
    <div id="root"></div>
    <script>
      (function() {
        'use strict';

        const DEBUG = false;

        function log(...args) {
          if (DEBUG) console.log('[Portals Map]', ...args);
        }

        function waitForElement(selector, timeout = 5000) {
          return new Promise((resolve, reject) => {
            const element = document.querySelector(selector);
            if (element) return resolve(element);

            const observer = new MutationObserver(() => {
              const element = document.querySelector(selector);
              if (element) {
                observer.disconnect();
                resolve(element);
              }
            });

            observer.observe(document.getElementById('root'), {
              childList: true,
              subtree: true
            });

            setTimeout(() => {
              observer.disconnect();
              reject(new Error(`Element ${selector} not found within ${timeout}ms`));
            }, timeout);
          });
        }

        function setupCloseButton() {
          // Wait for close button to appear in DOM
          waitForElement('[data-portals-close], [class*="close" i], [aria-label*="close" i]')
            .then(closeButton => {
              log('Close button found, attaching handler');

              closeButton.addEventListener('click', function(e) {
                try {
                  if (typeof PortalsSdk !== 'undefined') {
                    PortalsSdk.closeIframe();
                    log('Iframe closed via Portals SDK');
                  } else {
                    // Fallback: postMessage to parent
                    window.parent.postMessage({ type: 'CLOSE_IFRAME' }, '*');
                    log('Close message sent to parent (SDK unavailable)');
                  }
                } catch (error) {
                  console.error('Failed to close iframe:', error);
                }
              });
            })
            .catch(error => {
              console.warn('Could not find close button:', error.message);
            });
        }

        function setupTaskProgressListener() {
          // Listen for messages from Portals (same system as status-bar.html)
          if (typeof PortalsSdk !== 'undefined' && PortalsSdk.setMessageListener) {
            PortalsSdk.setMessageListener(function(message) {
              log('PORTALS MSG:', message);

              // Parse the message to extract taskscompleted and tasksrequired
              const completedMatch = message.match(/taskscompleted\s*:\s*(\d+)/);
              const requiredMatch = message.match(/tasksrequired\s*:\s*(\d+)/);

              if (completedMatch && requiredMatch) {
                const completed = parseInt(completedMatch[1]);
                const required = parseInt(requiredMatch[1]);
                log('Updating task progress:', completed, '/', required);

                // Dispatch custom event for React app to listen to
                const event = new CustomEvent('portalsTaskUpdate', {
                  detail: {
                    completed: completed,
                    required: required,
                    percentage: required > 0 ? Math.round((completed / required) * 100) : 0
                  }
                });
                window.dispatchEvent(event);
              }
            });
            log('Task progress listener initialized');
          } else {
            console.warn('PortalsSdk.setMessageListener not available');
          }
        }

        // Initialize when DOM is ready
        function initialize() {
          setupCloseButton();
          setupTaskProgressListener();
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initialize);
        } else {
          initialize();
        }
      })();
    </script>
  </body>
</html>
